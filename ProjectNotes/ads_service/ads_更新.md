# ADS更新计划

1、增加任务锁，不再重复读

2、增加账号使用状态



## 一、增加任务锁

### 1、需求：

1. 确保每天凌晨下载前5天数据的任务不会被阻塞
2. 确保实时下载任务（10分钟）能够在上次实时下载任务整体结束之后进行
3. 不再尝试获取未启用账号信息（人工标注）

### 2、实现：

* 设置一个锁模块
* 模块中维持一个set 保存正在进行任务的记录，记录构成：请求类型+game+ads_code+参数时间
* 在InsightsNormal.prototype.download触发downloadUrl之前将检查是否有任务没有完成，如果有，则跳出。没有构成一条记录，加入set。



## 二、20210602海外tiktok token获取

### 1、需求：

海外tiktok版本更新，token获取接口地址变动

### 2、实现

更新数据库配置

```sql
UPDATE  ads_channels SET token='{"req_type":"POST","header":{"Content-Type": "application/json"},"url":"https://ads.tiktok.com/open_api/v1.2/oauth2/access_token/","req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"},{"k": "secret", "v":"downloadParams->client_config->secret"},{"k":"auth_code", "v":"downloadParams->code"}],"resp_info":[{"k":"access_token", "v":"retaData->data->access_token"},{"k":"access_token_expires_in", "v":"315360000"},{"k":"account_id","v":"retaData->data->advertiser_ids"}]}'where code=;
UPDATE  ads_channels SET token='{"req_type":"GET", "header":{"Content-Type": "application/json"}, "url":"https://api.e.qq.com/oauth/token", "req_info":[{"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k": "client_secret", "v":"downloadParams->client_config->secret"}, {"k":"authorization_code", "v":"downloadParams->code"}, {"k":"grant_type", "v":"authorization_code"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=3y51sw"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}]}'where code='3y51sw';

UPDATE  ads_channels SET token='{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.oceanengine.com/open_api/oauth2/access_token/", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"auth_code", "v":"downloadParams->code"}, {"k":"grant_type", "v":"auth_code"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}, {"k":"account_id", "v":"retaData->data->advertiser_ids"}]}'where code='7na40w';

UPDATE  ads_channels SET token='{"req_type":"GET", "header":{}, "url":"https://api.biz.weibo.com/oauth/token", "req_info":[{"k":"grant_type", "v":"authorization_code"}, {"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=5c31d9"}, {"k":"code", "v":"downloadParams->code"}], "resp_info":[{"k":"access_token", "v":"retaData->access_token"}, {"k":"refresh_token", "v":"retaData->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->refresh_expires_in"}]}' where code='5c31d9';

UPDATE  ads_channels SET token='{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.e.kuaishou.com/rest/openapi/oauth2/authorize/access_token", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"auth_code", "v":"downloadParams->code"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}, {"k":"account_id", "v":"retaData->data->advertiser_id"}]}'where code='4d09e5';

```

## 三、20210603 所有服务迁移到海外

### 1、需求

所有服务迁移至海外服务器，以满足管理需要

### 2、实现过程

* 迁移数据

```sql
\copy op_sys.ads_account  from '/home/yinghui.zhang/ads_account_file.csv' with (FORMAT csv,DELIMITER ',',escape '\',header false,quote '"',encoding 'UTF8');

\copy op_sys.ads_api_authorize  from '/home/yinghui.zhang/ads_api_authorize_file.csv' with (FORMAT csv,DELIMITER ',',escape '\',header false,quote '"',encoding 'UTF8')

\copy op_sys.ads_api_template  from '/home/yinghui.zhang/ads_api_template_file.csv' with (FORMAT csv,DELIMITER ',',escape '\',header false,quote '"',encoding 'UTF8')
                                                                                
\copy op_sys. ads_channels  from '/home/yinghui.zhang/ads_channels_file.csv' with (FORMAT csv,DELIMITER ',',escape '\',header false,quote '"',encoding 'UTF8')

```

* 更新数据

```sql
(5,'4d09e5','active_callback','http://ad.partner.gifshow.com/track/activate','{"Accept": "application/json,application/text+gw2.0"}','GET','[{"k": "callback", "v": "downloadParams->postbackParams->callback"}]','[]','{"type": "JSON", "info": [{"k": "result", "v": "retData->result"}, {"k":"error_msg", "v":"retData->error_msg"}]}','{"sumsrc":"kuaishou"}'),
(6,'4d09e5','marketing_creative','https://ad.e.kuaishou.com/rest/openapi/v1/creative/list','{"Access-Token": "#{access_token}"}','POST','{"advertiser_id": "#{account_id}", "page": 1, "page_size": 500}','[]','{"type": "JSON", "info": [{"k": "page_size", "v": "downloadParams->params->page_size"}, {"k": "total_count", "v": "retData->data->total_count"}, {"k": "raw_data", "v": "retData->data->details"}, {"k": "page", "v": "downloadParams->params->page"}]}','{"sumsrc":"kuaishou", "use": "获取广告创意信息", "url":"https://yiqixie.com/d/home/fcAB8NFoHn82gbNSTAM4rU2re#section=h.6em3b88xlhok"}'),
(8,'3y51sw','cur_creative_report','https://api.e.qq.com/v1.3/hourly_reports/get','{"Accept": "application/json,application/text+gw2.0"}','GET','{"account_id": "#{account_id}", "level":"REPORT_LEVEL_AD", "date_range":{"start_date": "#{STRATEGY_DATE_START}", "end_date" : "#{STRATEGY_DATE_END}"}, "access_token":"#{access_token}", "fields": "[\"hour\",\"impression\",\"click\",\"cost\",\"download\",\"conversion\",\"activation\",\"ad_id\", \"adgroup_id\", \"campaign_id\"]", "page": 1, "page_size": 1000, "group_by":"[\"hour\",\"ad_id\"]", "timestamp":"downloadParams->timestamp", "nonce":"downloadParams->timestamp"}','[{"log": "daily", "date": "#{DATE_YESTERDAY}", "update_days": 1}, {"log": "hourly", "date": "#{DATE_TODAY}", "update_days": 0}]','{"type": "JSON", "date": "downloadParams->params->date_range->start_date", "info": [{"k": "pages", "v": "retData->data->page_info->total_page"}, {"k": "raw_data", "v": "retData->data->list"}, {"k": "page", "v": "downloadParams->params->page"}]}','{"sumsrc":"gdt", "use": "广告创意数据（实时）", "url":"https://ad.oceanengine.com/openapi/doc/index.html?id=416"}'),
(4,'5c31d9','active_callback','http://appmonitor.biz.weibo.com/sdkserver/active','{"Accept": "application/json,application/text+gw2.0"}','GET','[{"k": "company", "v":"ningmengweiqu"}, {"k": "num", "v": 17}, {"k": "action_type", "v": 1}, {"k": "IMP", "v": "downloadParams->other->imp"}]','[]','{"type": "JSON", "info": [{"k": "IMP", "v":"downloadParams->other->IMP"}, {"k": "result", "v": "retData->result"}, {"k":"code", "v":"retData->Code"}]}','{"sumsrc":"weibofensitong"}'),
(10,'7na40w','get_ads_list','https://ad.oceanengine.com/open_api/2/majordomo/advertiser/select/','[{"k": "Access-Token", "v": "downloadParams->accessToken"}]','GET','[{"k": "advertiser_id", "v": "downloadParams->advertiser_id"}]','','[{"k": "code", "v": "retData->code"}, {"k": "succCode", "v": 0}, {"k": "adsList", "v": "retData->data->list"}]','{"sumsrc": "toutiao"}'),
(7,'7na40w','cur_creative_report','https://ad.oceanengine.com/open_api/2/report/creative/get/','{"Access-Token": "#{access_token}"}','GET','{"start_date": "#{STRATEGY_DATE_START}", "end_date" : "#{STRATEGY_DATE_END}", "advertiser_id": "#{account_id}", "group_by":"[\"STAT_GROUP_BY_FIELD_ID\",\"STAT_GROUP_BY_FIELD_STAT_TIME\"]","time_granularity":"STAT_TIME_GRANULARITY_HOURLY", "page": 1, "page_size": 1000, "status":"CREATIVE_STATUS_ALL"}','[{"log": "daily", "date": "#{DATE_YESTERDAY}", "update_days": 1}, {"log": "hourly", "date": "#{DATE_TODAY}", "update_days": 0}]','{"type": "JSON", "date": "downloadParams->params->start_date", "info": [{"k": "pages", "v": "retData->data->page_info->total_page"}, {"k": "raw_data", "v": "retData->data->list"}, {"k": "page", "v": "downloadParams->params->page"}]}','{"sumsrc":"jinri", "use": "广告创意数据（实时）", "url":"https://ad.oceanengine.com/openapi/doc/index.html?id=416"}'),
(3,'4d09e5','cur_program_creative_report','https://ad.e.kuaishou.com/rest/openapi/v1/report/program_creative_report','{"Access-Token": "#{access_token}"}','POST','{"start_date_min": "#{STRATEGY_DATE_START} 00:00", "end_date_min" : "#{STRATEGY_DATE_END} 23:59", "advertiser_id": "#{account_id}", "page": 1, "page_size": 2000, "temporal_granularity": "HOURLY"}','[{"log": "daily", "date": "#{DATE_YESTERDAY}", "update_days": 1}, {"log": "hourly", "date": "#{DATE_TODAY}", "update_days": 0}]','{"type": "JSON", "date": "stat_date", "info": [{"k": "page_size", "v": "downloadParams->params->page_size"}, {"k": "total_count", "v": "retData->data->total_count"}, {"k": "raw_data", "v": "retData->data->details"}, {"k": "page", "v": "downloadParams->params->page"}]}','{"sumsrc":"kuaishou", "use": "程序化创意2.0报表（实时）", "url":"https://yiqixie.com/d/home/fcAC2OzurfmGRLHLJsNRz_wIX#section=h.xj9os51yoz2d"}'),
(9,'7na40w','get_auth_ads','https://ad.oceanengine.com/open_api/oauth2/advertiser/get/','[{"k": "Content-Type", "v": "application/json"}]','GET','[{"k": "access_token", "v": "downloadParams->accessToken"}, {"k": "app_id", "v": "downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}]','','[{"k": "code", "v": "retData->code"}, {"k": "succCode", "v": 0}, {"k": "authAds", "v": "retData->data->list"}]','{"sumsrc": "toutiao"}'),
(2,'4d09e5','cur_creative_report','https://ad.e.kuaishou.com/rest/openapi/v1/report/creative_report/','{"Access-Token": "#{access_token}"}','POST','{"start_date": "#{STRATEGY_DATE_START}", "end_date" : "#{STRATEGY_DATE_END}", "advertiser_id": "#{account_id}", "page": 1, "page_size": 2000, "temporal_granularity": "HOURLY"}','[{"log": "daily", "date": "#{DATE_YESTERDAY}", "update_days": 1}, {"log": "hourly", "date": "#{DATE_TODAY}", "update_days": 0}]','{"type": "JSON", "date": "stat_date", "info": [{"k": "page_size", "v": "downloadParams->params->page_size"}, {"k": "total_count", "v": "retData->data->total_count"}, {"k": "raw_data", "v": "retData->data->details"}, {"k": "page", "v": "downloadParams->params->page"}]}','{"sumsrc":"kuaishou", "use": "广告创意数据（实时）", "url":"https://yiqixie.com/d/home/fcAC2OzurfmGRLHLJsNRz_wIX#section=h.gv23x1sjizhc"}'),
(1,'5c31d9','cur_creative_report','https://api.biz.weibo.com/v3/insights/effect','{"Authorization": "Bearer #{access_token}", "Accept": "application/json,application/text+gw2.0"}','GET','{"time_interval": ["#{STRATEGY_DATE_START}", "#{STRATEGY_DATE_END}"], "order_by": ["date"], "granularity": ["account", "ad", "campaign", "creative", "campaign_objective", "account", "date", "hour"], "page": 1, "rows": 20, "field": ["pv", "bhv", "ecpm", "consume", "bhv_70000001", "transform", "acpe"], "param": {}, "order_mode": "desc"}','[{"log": "daily", "date": "#{DATE_YESTERDAY}", "update_days": 1}, {"log": "hourly", "date": "#{DATE_TODAY}", "update_days": 0}]','{"type": "JSON", "date": "date", "info": [{"k": "pages", "v":"retData->pages"}, {"k": "page", "v": "retData->page"}, {"k":"raw_data", "v":"retData->list"}]}','{"sumsrc":"weibofensitong"}'),

(11,'6211a5','cur_creative_report','https://ads.tiktok.com/open_api/v1.2/reports/integrated/get/','{"Access-Token": "#{access_token}"}','GET','{"report_type":"AUDIENCE","data_level":"AUCTION_AD","start_date":"#{STRATEGY_DATE_START}","end_date" : "#{STRATEGY_DATE_END}","lifetime" : "false","advertiser_id": "#{account_id}","dimensions":"[\"ad_id\",\"stat_time_hour\","country_code"]","page": 1,"page_size": 1000,"metrics":"[\"campaign_name\",\"campaign_id\",\"adgroup_name\",\"adgroup_id\",\"ad_name\",\"ad_text\",\"spend\",\"impressions\",\"clicks\",\"conversion\",\"conversion_rate\"]"}','[{"log": "daily","date":"#{DATE_YESTERDAY}","update_days": 1},{"log": "hourly","date": "#{DATE_TODAY}","update_days": 0}]','{"type": "JSON","date":"downloadParams->params->start_date","info":[{"k": "pages", "v": "retData->data->page_info->total_page"},{"k": "raw_data", "v": "retData->data->list"},{"k": "page", "v": "downloadParams->params->page"}]}','\N');

(5,'6211a5','tiktok','oauth2','[{"game":"3a9d70", "client_id":"6933620775035338753", "secret":"a81e074b722a4cd762d8feba372618c8ac006e6f"}]','{"req_type":"GET","url":"https://ads.tiktok.com/marketing_api/auth","redirect_uri":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=6211a5","req_info":[{"k":"scope","v":"[4]"},{"k": "app_id", "v":"downloadParams->client_config->client_id"},{"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=6211a5"}],"resp_info":[{"k":"code","v":"retData->query->auth_code"}]}','{"req_type":"POST","header":{"Content-Type": "application/json"},"url":"https://ads.tiktok.com/open_api/v1.2/oauth2/access_token/","req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"},{"k": "secret", "v":"downloadParams->client_config->secret"},{"k":"auth_code", "v":"downloadParams->code"}],"resp_info":[{"k":"access_token", "v":"retaData->data->access_token"},{"k":"access_token_expires_in", "v":"315360000"},{"k":"account_id","v":"retaData->data->advertiser_ids"},{"k":"refresh_token_expires_in","v":"315360000"}]}','','')
(3,'7na40w','jinri','oauth2','[{"game":"89741e", "client_id":1643812138172428, "secret":"b6ff76f5f8ffa315f8adeadfb00c8213fd10b723"}, {"game":"51bcd0", "client_id":1609555257483351, "secret":"dcf11b3243578aa3d9f4efba6fb11b7a9067b92d"}]','{"req_type":"GET", "url":"https://ad.toutiao.com/openapi/audit/oauth.html", "redirect_uri":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=7na40w", "req_info":[{"k":"scope", "v":[1,2,3,4,5]}, {"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=7na40w"}], "resp_info":[{"k":"code", "v":"retData->query->auth_code"}]}','{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.oceanengine.com/open_api/oauth2/access_token/", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"auth_code", "v":"downloadParams->code"}, {"k":"grant_type", "v":"auth_code"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}, {"k":"account_id", "v":"retaData->data->advertiser_ids"}]}','{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.oceanengine.com/open_api/oauth2/refresh_token/", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"refresh_token", "v":"downloadParams->refresh_token"}, {"k":"grant_type", "v":"refresh_token"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}]}','\N'),
(4,'3y51sw','gdt','oauth2','[{"game":"89741e", "client_id":1110822553, "secret":"5Fri34XRpOUanbxs"}, {"game":"51bcd0", "client_id":1107728027, "secret":"lWj4FZl9D8GsM5S8"}]','{"req_type":"GET", "url":"https://developers.e.qq.com/oauth/authorize", "redirect_uri":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=3y51sw", "req_info":[{"k":"account_type", "v":"ACCOUNT_TYPE_QQ"}, {"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=3y51sw"}], "resp_info":[{"k":"code", "v":"retData->query->authorization_code"}]}','{"req_type":"GET", "header":{"Content-Type": "application/json"}, "url":"https://api.e.qq.com/oauth/token", "req_info":[{"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k": "client_secret", "v":"downloadParams->client_config->secret"}, {"k":"authorization_code", "v":"downloadParams->code"}, {"k":"grant_type", "v":"authorization_code"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=3y51sw"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}]}','{"req_type":"GET", "header":{"Content-Type": "application/json"}, "url":"https://api.e.qq.com/oauth/token", "req_info":[{"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k": "client_secret", "v":"downloadParams->client_config->secret"}, {"k":"refresh_token", "v":"downloadParams->refresh_token"}, {"k":"grant_type", "v":"refresh_token"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}]}','\N'),
(2,'4d09e5','kuaishou','oauth2','[{"game":"89741e", "client_id":5, "secret":"5MFA6O@Mt4GHjCNl"}, {"game":"51bcd0", "client_id":5, "secret":"5MFA6O@Mt4GHjCNl"}]','{"req_type":"GET", "url":"https://ad.e.kuaishou.com/#/openapi/oauth", "redirect_uri":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=4d09e5", "req_info":[{"k":"scope", "v":"[\\"ad_query\\",\\"ad_manage\\",\\"report_service\\",\\"account_service\\"]"}, {"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=4d09e5"}], "resp_info":[{"k":"code", "v":"retData->query->auth_code"}]}','{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.e.kuaishou.com/rest/openapi/oauth2/authorize/access_token", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"auth_code", "v":"downloadParams->code"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}, {"k":"account_id", "v":"retaData->data->advertiser_id"}]}','{"req_type":"POST", "header":{"Content-Type": "application/json"}, "url":"https://ad.e.kuaishou.com/rest/openapi/oauth2/authorize/refresh_token", "req_info":[{"k": "app_id", "v":"downloadParams->client_config->client_id"}, {"k": "secret", "v":"downloadParams->client_config->secret"}, {"k":"refresh_token", "v":"downloadParams->refresh_token"}], "resp_info":[{"k":"access_token", "v":"retaData->data->access_token"}, {"k":"refresh_token", "v":"retaData->data->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->data->access_token_expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->data->refresh_token_expires_in"}, {"k":"account_id", "v":"retaData->data->advertiser_id"}]}','\N'),
(1,'5c31d9','weibofensitong','oauth2','[{"game":"89741e", "client_id":202004232375931100}, {"game":"51bcd0", "client_id":202004232375931100}]','{"req_type":"GET", "header":{}, "url":"https://api.biz.weibo.com/oauth/authorize", "redirect_uri":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=5c31d9", "req_info":[{"k":"response_type", "v":"code"}, {"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=5c31d9"}, {"k":"scope", "v":"ads_read"}], "resp_info":[{"k":"code", "v":"retData->query->code"}]}','{"req_type":"GET", "header":{}, "url":"https://api.biz.weibo.com/oauth/token", "req_info":[{"k":"grant_type", "v":"authorization_code"}, {"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k":"redirect_uri", "v":"http://ads.oper.microfun.com/s2s/authCallback?ads_code=5c31d9"}, {"k":"code", "v":"downloadParams->code"}], "resp_info":[{"k":"access_token", "v":"retaData->access_token"}, {"k":"refresh_token", "v":"retaData->refresh_token"}, {"k":"access_token_expires_in", "v":"retaData->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->refresh_expires_in"}]}','{"req_type":"GET", "header":{}, "url":"https://api.biz.weibo.com/oauth/token", "req_info":[{"k":"grant_type", "v":"refresh_token"}, {"k": "client_id", "v":"downloadParams->client_config->client_id"}, {"k":"refresh_token", "v":"downloadParams->refresh_token"}, {"k":"code", "v":"downloadParams->code"}], "resp_info":[{"k":"access_token", "v":"retaData->access_token"},  {"k":"access_token_expires_in", "v":"retaData->expires_in"}, {"k":"refresh_token_expires_in", "v":"retaData->refresh_expires_in"}]}','\N');

```

```sql
UPDATE ads_api_template set params='{"report_type":"AUDIENCE","data_level":"AUCTION_AD","start_date":"#{STRATEGY_DATE_START}","end_date" : "#{STRATEGY_DATE_END}","lifetime" : "false","advertiser_id": "#{account_id}","dimensions":"[\"ad_id\",\"stat_time_hour\","country_code"]","page": 1,"page_size": 1000,"metrics":"[\"campaign_name\",\"campaign_id\",\"adgroup_name\",\"adgroup_id\",\"ad_name\",\"ad_text\",\"spend\",\"impressions\",\"clicks\",\"conversion\",\"conversion_rate\"]"}','[{"log": "daily","date":"#{DATE_YESTERDAY}","update_days": 1},{"log": "hourly","date": "#{DATE_TODAY}","update_days": 0}]'
where id=11;

DELETE FROM ads_api_template where id=11;
INSERT INTO ads_api_template values
(11,'6211a5','cur_creative_report','https://ads.tiktok.com/open_api/v1.2/reports/integrated/get/','{"Access-Token": "#{access_token}"}','GET','{"report_type":"AUDIENCE","data_level":"AUCTION_AD","start_date":"#{STRATEGY_DATE_START}","end_date" : "#{STRATEGY_DATE_END}","lifetime" : "false","advertiser_id": "#{account_id}","dimensions":"[\"ad_id\",\"stat_time_hour\",\"country_code\"]","page": 1,"page_size": 1000,"metrics":"[\"campaign_name\",\"campaign_id\",\"adgroup_name\",\"adgroup_id\",\"ad_name\",\"ad_text\",\"spend\",\"impressions\",\"clicks\",\"conversion\",\"conversion_rate\"]"}','[{"log": "daily","date":"#{DATE_YESTERDAY}","update_days": 1},{"log": "hourly","date": "#{DATE_TODAY}","update_days": 0}]','{"type": "JSON","date":"downloadParams->params->start_date","info":[{"k": "pages", "v": "retData->data->page_info->total_page"},{"k": "raw_data", "v": "retData->data->list"},{"k": "page", "v": "downloadParams->params->page"}]}','\N');
```



